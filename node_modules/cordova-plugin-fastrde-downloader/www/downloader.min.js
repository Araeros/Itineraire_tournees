function createEvent(a,b){b=b||[];var c=document.createEvent("Event");c.initEvent(a),c.name=a,c.data=b;var d=a;return b[0]&&(d+=" : "+b[0]),c}var Downloader={localFolder:null,fileSystemURL:null,fileSystem:null,unzipQueue:[],downloadQueue:[],fileObjects:[],fileObjectInProgress:null,fileObjectInUnzipProgress:null,wifiOnly:!1,autoUnzip:!1,autoRemove:!0,autoCheck:!1,noMedia:!0,loading:!1,unzipping:!1,initialized:!1,transfer:null,initialize:function(a){Downloader.setFolder(a.folder),"undefined"!=typeof a.unzip&&Downloader.setAutoUnzip(a.unzip),"undefined"!=typeof a.remove&&Downloader.setRemoveAfterUnzip(a.remove),"undefined"!=typeof a.check&&Downloader.setAutoCheck(a.check),"undefined"!=typeof a.wifiOnly&&Downloader.setWifiOnly(a.wifiOnly),"undefined"!=typeof a.noMedia&&Downloader.setNoMedia(a.noMedia),"undefined"!=typeof a.fileSystem&&(Downloader.fileSystemURL=a.fileSystem),document.addEventListener("DOWNLOADER_downloadError",Downloader.onDownloadError,!1),document.addEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.addEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.addEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.addEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.addEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1),Downloader.getFilesystem()},load:function(a,b){if(b=b||null,!Downloader.isInitialized())return void document.addEventListener("DOWNLOADER_initialized",function d(c){c.target.removeEventListener("DOWNLOADER_initialized",d,!1),Downloader.load(a,b)},!1);var c={url:a,name:a.replace(/^.*\//,""),md5:b};return Downloader.downloadQueue.push(c),Downloader.isLoading()||Downloader.loadNextInQueue(),c.name},abort:function(){null!==Downloader.transfer&&(Downloader.transfer.abort(),Downloader.transfer=null),Downloader.reset()},unzip:function(a){Downloader.unzipQueue.push(a),Downloader.isUnzipping()||Downloader.unzipNextInQueue()},loadNextInQueue:function(){if(Downloader.downloadQueue.length>0){Downloader.loading=!0;var a=Downloader.downloadQueue.shift();return Downloader.fileObjectInProgress=a,Downloader.transferFile(a),!0}return!1},unzipNextInQueue:function(){if(Downloader.unzipQueue.length>0){Downloader.unzipping=!0;var a=Downloader.unzipQueue.shift();return Downloader.fileObjectInUnzipProgress=a,Downloader._unzip(a),!0}return!1},transferFile:function(a){var b=Downloader.localFolder.toURL()+"/"+a.name;Downloader.transfer=new FileTransfer,Downloader.transfer.onprogress=function(b){if(b.lengthComputable){var c=Math.floor(b.loaded/b.total*100);document.dispatchEvent(createEvent("DOWNLOADER_downloadProgress",[c,a.name]))}},Downloader.transfer.download(a.url,b,function(a){document.dispatchEvent(createEvent("DOWNLOADER_downloadSuccess",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_downloadError",[a]))})},_unzip:function(a){var b=Downloader.localFolder.toURL();zip.unzip(b+"/"+a,b,function(b){0==b?document.dispatchEvent(createEvent("DOWNLOADER_unzipSuccess",[a])):document.dispatchEvent(createEvent("DOWNLOADER_unzipError",[a]))},function(b){var c=Math.floor(b.loaded/b.total*100);document.dispatchEvent(createEvent("DOWNLOADER_unzipProgress",[c,a]))})},check:function(a,b){var c=Downloader.localFolder;c.getFile(a,{create:!1,exclusive:!1},function(c){md5chksum.file(c,function(c){c==b?document.dispatchEvent(createEvent("DOWNLOADER_fileCheckSuccess",[c,a])):document.dispatchEvent(createEvent("DOWNLOADER_fileCheckFailed",[c,b,a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_fileCheckError",[a]))})},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},removeFile:function(a){var b=Downloader.localFolder;b.getFile(a,{create:!1,exclusive:!1},function(a){a.remove(function(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoved",[a]))},function(){document.dispatchEvent(createEvent("DOWNLOADER_fileRemoveError",[a]))})},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},isLoading:function(){return Downloader.loading},isUnzipping:function(){return Downloader.unzipping},isInitialized:function(){return Downloader.initialized},isWifiOnly:function(){return Downloader.wifiOnly},isAutoUnzip:function(){return Downloader.autoUnzip},isAutoRemove:function(){return Downloader.autoRemove},isAutoCheck:function(){return Downloader.autoCheck},isWifiConnection:function(){var a=navigator.connection.type;return a==Connection.WIFI?!0:!1},isZipFile:function(a){return a.match(/\.zip$/)?!0:!1},isNoMedia:function(){return Downloader.noMedia},setFolder:function(a){Downloader.localFolder=a},setWifiOnly:function(a){Downloader.wifiOnly=a},setNoMedia:function(a){Downloader.noMedia=a},setAutoUnzip:function(a){Downloader.autoUnzip=a},setAutoCheck:function(a){Downloader.autoCheck=a},setRemoveAfterUnzip:function(a){Downloader.autoRemove=a},reset:function(){Downloader.downloadQueue=[],Downloader.unzipQueue=[],Downloader.fileObjects=[],Downloader.fileObjectInProgress=null,Downloader.fileObjectInUnzipProgress=null,Downloader.initialized=!1,Downloader.loading=!1,Downloader.unzipping=!1},getFilesystem:function(){Downloader.fileSystemURL?window.resolveLocalFileSystemURI(Downloader.fileSystemURL,function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))}):(window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFileSystem",[a.root]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))}))},getFolder:function(a,b){a.getDirectory(b,{create:!0,exclusive:!1},function(a){document.dispatchEvent(createEvent("DOWNLOADER_gotFolder",[a]))},function(a){document.dispatchEvent(createEvent("DOWNLOADER_error",[a]))})},touchNoMedia:function(){var a=Downloader.localFolder;a.getFile(".nomedia",{create:!0,exclusive:!1},function(a){},function(a){document.dispatchEvent(createEvent("DOWNLOADER_getFileError",[a]))})},onDownloadSuccess:function(a){var b=a.data[0];if(Downloader.isAutoCheck()){var c=Downloader.fileObjectInProgress.md5;Downloader.check(b.name,c)}else Downloader.isAutoUnzip()&&Downloader.isZipFile(b.name)&&Downloader.unzip(b.name);Downloader.loadNextInQueue()||(Downloader.loading=!1,Downloader.fileObjectInProgress=null)},onDownloadError:function(a){Downloader.reset(),document.removeEventListener("DOWNLOADER_onDownloadError",Downloader.onDownloadError,!1),document.removeEventListener("DOWNLOADER_gotFileSystem",Downloader.onGotFileSystem,!1),document.removeEventListener("DOWNLOADER_gotFolder",Downloader.onGotFolder,!1),document.removeEventListener("DOWNLOADER_downloadSuccess",Downloader.onDownloadSuccess,!1),document.removeEventListener("DOWNLOADER_unzipSuccess",Downloader.onUnzipSuccess,!1),document.removeEventListener("DOWNLOADER_fileCheckSuccess",Downloader.onCheckSuccess,!1)},onUnzipSuccess:function(a){var b=a.data[0];Downloader.isAutoRemove()&&Downloader.removeFile(b),Downloader.unzipNextInQueue()||(Downloader.unzipping=!1,Downloader.fileObjectInUnzipProgress=null)},onCheckSuccess:function(a){var b=a.data[1];Downloader.isAutoUnzip()&&Downloader.isZipFile(b)&&Downloader.unzip(b)},onGotFileSystem:function(a){a.target.removeEventListener(a.name,Downloader.onGotFileSystem);var b=a.data[0];Downloader.fileSystem=b,Downloader.getFolder(b,Downloader.localFolder)},onGotFolder:function(a){a.target.removeEventListener(a.name,Downloader.onGotFolder);var b=a.data[0];Downloader.localFolder=b,Downloader.initialized=!0,Downloader.isNoMedia()&&Downloader.touchNoMedia(),document.dispatchEvent(createEvent("DOWNLOADER_initialized"))},"interface":{obj:null,init:function(a){return a.folder?(a=a||{},Downloader.initialize(a),void(Downloader["interface"].obj=Downloader)):void console.error("You have to set a folder to store the downloaded files into.")},get:function(a,b){return a?Downloader.isWifiOnly()&&!Downloader.isWifiConnection()?void document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection")):Downloader.load(a,b):void console.error("You have to specify a url where the file is located you wanna download")},getMultipleFiles:function(a){if(Downloader.isWifiOnly()&&!Downloader.isWifiConnection())return void document.dispatchEvent(createEvent("DOWNLOADER_noWifiConnection"));for(var b=0;b<a.length;b++){var c=a[b];Downloader.load(c.url,c.md5)}},abort:function(){Downloader.abort()},isInitialized:function(){return Downloader.isInitialized()},setWifiOnly:function(a){Downloader.setWifiOnly(a)},setNoMedia:function(a){Downloader.setNoMedia(a)},setAutoUnzip:function(a){Downloader.setAutoUnzip(a)},setAutoCheck:function(a){Downloader.setAutoCheck(a)},setRemoveAfterUnzip:function(a){Downloader.setRemoveAfterUnzip(a)}}};module.exports=Downloader["interface"];